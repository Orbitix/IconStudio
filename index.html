<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Icon Studio</title>

    <!-- Material Symbols -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Font Awesome -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"> -->
    <script src="https://kit.fontawesome.com/187c1afb2a.js" crossorigin="anonymous"></script>

    <!-- Pickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* Base Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --bg-primary: #1e1e1e;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-primary: #2196f3;
            --accent-secondary: #1976d2;
            --border-color: #404040;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;

            /* Sizes */
            --sidebar-width: 240px;
            --toolbar-height: 48px;
            --panel-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-areas:
                'header header header'
                'workstrip workstrip workstrip'
                'sidebar workspace panel';
            grid-template-rows: var(--toolbar-height) auto 1fr;
            grid-template-columns: var(--sidebar-width) 1fr var(--panel-width);
        }

        /* Header/Toolbar */
        .app-header {
            grid-area: header;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            gap: var(--spacing-md);
        }

        .app-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-right: auto;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-content {
            overflow-y: auto;
            flex: 1;
        }

        /* Main Workspace */
        .workspace {
            grid-area: workspace;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .workspace-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-xl);
        }

        /* Right Panel */
        .panel {
            grid-area: panel;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-section {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-content {
            overflow-y: auto;
            flex: 1;
        }

        /* Common Components */
        .button {
            padding: var(--spacing-xs) var(--spacing-xs);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button:hover {
            background: var(--accent-primary);
        }

        .button.active {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
        }

        /* Search Bar */
        .search-bar {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
        }

        .icon-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .icon-item:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .icon-item.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
        }

        /* Workspace Specific Styles */
        .workspace-toolbar {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .workspace-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Icon Preview */
        .icon-preview {
            position: relative;
            padding: var(--spacing-xl);
            background: var(--bg-tertiary);
            border-radius: 8px;
            min-width: 75px;
            min-height: 75px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-layers {
            position: relative;
            display: inline-block;
        }

        .preview-icon {
            font-size: 96px;
            display: block;
        }

        .preview-icon.primary {
            position: relative;
            z-index: 2;
        }

        .preview-icon.secondary {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Panel Controls */
        .panel-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: var(--spacing-md);
        }

        .control-group {
            margin-bottom: var(--spacing-md);
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-size: 14px;
        }

        .control-group input[type='range'] {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            -webkit-appearance: none;
        }

        .control-group input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Effect Options */
        .effect-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .effect-option {
            width: 100%;
            text-align: left;
        }

        /* Code Preview */
        .code-block {
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            color: var(--text-secondary);
        }

        /* Export Options */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: var(--spacing-md);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }

        /* Library Selector */
        .library-selector {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Style Selector */
        .style-selector {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Pickr Customization */
        .pickr {
            width: 100%;
        }

        .pickr button {
            width: 100%;
            height: 32px;
            border-radius: 4px;
        }

        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            body {
                grid-template-columns: var(--sidebar-width) 1fr var(--panel-width);
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-areas:
                    'header header'
                    'workspace panel';
                grid-template-columns: 1fr var(--panel-width);
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: var(--toolbar-height);
                bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 100;
            }

            .sidebar.active {
                transform: translateX(0);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            border-radius: 4px;
            color: var(--text-primary);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            border-color: #f44336;
        }

        /* Add these styles for better preview visibility */
        .preview-icon {
            font-size: 96px;
            display: block;
            min-height: 96px;
            min-width: 96px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-preview.dark-bg {
            background: #1a1a1a;
        }

        /* Add to your existing CSS */
        .icon-name {
            display: none;
            position: absolute;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .icon-item:hover .icon-name {
            display: block;
        }

        /* Style for the selected icon name in toolbar */
        .selected-icon-name {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            margin-left: auto;
            /* This will push it to the right of the zoom controls */
        }

        .color-pickers-row {
            display: flex;
            gap: var(--spacing-md);
        }

        .color-pickers-row .control-group {
            flex: 1;
        }

        /* Tour styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            pointer-events: none;
        }

        .tour-highlight {
            position: absolute;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            z-index: 1001;
            animation: pulse 2s infinite;
        }

        .tour-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 16px;
            max-width: 300px;
            z-index: 1002;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tour-tooltip-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7),
                    0 0 0 0 rgba(33, 150, 243, 0.4);
            }

            70% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7),
                    0 0 0 10px rgba(33, 150, 243, 0);
            }

            100% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7),
                    0 0 0 0 rgba(33, 150, 243, 0);
            }
        }

        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 1000;
            pointer-events: none;
        }

        .tour-highlight {
            position: absolute;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            z-index: 1001;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
            }
        }

        /* Working Icons Strip */
        .working-icons-strip {
            grid-area: workstrip;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .working-icons-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 var(--spacing-md);
        }

        .auto-update-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        /* Toggle Switch Styles */
        .toggle-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            gap: var(--spacing-md);
        }

        .toggle-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 24px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: 0.4s;
        }

        .toggle-label input:checked+.toggle-slider {
            background: var(--accent-primary);
        }

        .toggle-label input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Working Icons Grid */
        .working-icons-grid {
            display: flex;
            gap: var(--spacing-md);
            overflow-x: auto;
            padding: var(--spacing-sm);
            min-height: 100px;
        }

        .working-icon {
            position: relative;
            min-width: 94px;
            height: 94px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: var(--spacing-sm);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .working-icon:hover {
            background: var(--bg-primary);
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .working-icon .remove-icon {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .working-icon:hover .remove-icon {
            opacity: 1;
        }

        .workspace-toolbar {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .toolbar-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .working-icons-strip {
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .workspace {
            display: flex;
            flex-direction: column;
        }

        .workspace-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-xl);
            min-height: 0;
            /* Important for proper flex sizing */
        }

        .working-icons-strip {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            max-height: 245px;
            /* Limit the height */
            min-height: 120px;
            /* Ensure minimum visibility */
        }

        .working-icons-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .working-icons-header h3 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .working-icons-options {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .working-icons-grid {
            display: flex;
            gap: var(--spacing-md);
            overflow-x: auto;
            padding: var(--spacing-sm);
            /* Smooth scrolling for the grid */
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-tertiary);
        }

        /* Scrollbar styling */
        .working-icons-grid::-webkit-scrollbar {
            height: 6px;
        }

        .working-icons-grid::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .working-icons-grid::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        .workspace-toolbar {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* fix thie eventually */
        .working-icons-strip {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            height: 182px;
            /* Fixed height */
            max-height: 240;
        }

        .working-icons-grid {
            display: flex;
            gap: var(--spacing-md);
            overflow-x: auto;
            padding: var(--spacing-sm);
            height: 108px;
            /* Control height of icons row */
        }

        .working-icon {
            position: relative;
            min-width: 84px;
            /* Smaller width */
            height: 84px;
            /* Smaller height */
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: var(--spacing-xs);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .working-icon .icon-preview {
            font-size: 24px;
            /* Smaller icon size */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .working-icon .icon-name {
            font-size: 9px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .working-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        /* Add tooltip for truncated names */
        .working-icon .icon-name:hover {
            position: relative;
        }

        .working-icon .icon-name:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* end fix this eventually you lazy ass */

        .workspace-toolbar {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            height: var(--toolbar-height) + 5px;
            padding: 6px;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .icon-info {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Add to your CSS */
        .temp-icon-render {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .library-dropdown {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 200px;
            appearance: none;
            position: relative;
        }

        .library-dropdown:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Custom dropdown arrow */
        .library-selector {
            position: relative;
        }

        .library-selector::after {
            content: '▼';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
            font-size: 12px;
        }

        /* Optgroup styling */
        .library-dropdown optgroup {
            background: var(--bg-secondary);
            font-weight: 600;
            padding: 8px 0;
        }

        .library-dropdown option {
            background: var(--bg-tertiary);
            padding: 8px 12px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .loading-icon {
            font-size: 48px;
            animation: spin 2s linear infinite;
            color: var(--accent-primary);
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 16px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .library-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.library-dropdown {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 4px;
    min-width: 200px;
    appearance: none;
    position: relative;
}

.help-button {
    margin-left: var(--spacing-sm);
}

/* Style for the icon count info */
.library-info {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.icon-count-badge {
    padding: 2px 6px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    font-family: monospace;
}
.library-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.icon-count-badge {
    padding: 2px 6px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    font-family: monospace;
    color: var(--text-secondary);
    font-size: 12px;
    min-width: fit-content;
}

.color-pickers-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.swap-colors-btn {
    align-self: flex-end;
    margin-bottom: 4px; /* Align with color pickers */
    padding: 4px;
}

.swap-colors-btn .material-symbols-outlined {
    font-size: 20px;
}


.split-button {
    position: relative;
    display: inline-flex;
    align-items: stretch;
}

.split-button .effect-option {
    border-radius: 4px 0 0 4px;
    flex-grow: 1;
}

.split-button .dropdown-trigger {
    border-radius: 0 4px 4px 0;
    padding: 0 8px;
    border-left: 1px solid var(--border-color);
}

.gradient-angles {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    display: none;
    z-index: 1000;
}

.gradient-angles.active {
    display: block;
}

.gradient-angles button {
    display: block;
    width: 100%;
    padding: 8px 16px;
    border: none;
    background: none;
    color: var(--text-primary);
    text-align: left;
    cursor: pointer;
}

.gradient-angles button:hover {
    background: var(--bg-tertiary);
}
    </style>
</head>

<body>
    <!-- Add this right after the body opening tag -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <span class="material-symbols-outlined loading-icon">sync</span>
            <span class="loading-text">Loading Icons...</span>
        </div>
    </div>

    <!-- Main App Structure -->
    <header class="app-header">
        <h1 class="app-title">Icon Studio</h1>


        <div class="toolbar-section">
            <div class="library-controls">
                <span id="iconCount" class="icon-count-badge"></span>
                <select class="library-dropdown" id="librarySelect">
                    <optgroup label="Material Symbols">
                        <option value="material-outlined">Outlined</option>
                        <option value="material-rounded">Rounded</option>
                        <option value="material-sharp">Sharp</option>
                    </optgroup>
                    <optgroup label="Font Awesome">
                        <option value="fa-solid">Solid</option>
                        <option value="fa-regular">Regular</option>
                        <option value="fa-brands">Brands</option>
                    </optgroup>
                </select>
                <button class="button help-button" id="startTour">
                    <span class="material-symbols-outlined">help_outline</span>
                </button>
            </div>
        </div>
        <div class="style-selector" style="display: none">
            <!-- Dynamically populated based on selected library -->
       </div>

    </header>

    <!-- Left Sidebar - Icon Libraries -->
    <aside class="sidebar">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search icons..." id="searchInput" />
        </div>
        <div class="sidebar-content">
            <div class="icon-grid" id="iconGrid">
                <!-- Icons will be populated here -->
            </div>
        </div>
    </aside>

    <!-- Main Workspace -->
    <main class="workspace">
        <div class="workspace-toolbar">
            <div class="toolbar-left">
                <button class="button" id="toggleBackground">
                    Toggle Background
                </button>
                <button class="button" id="resetView">Reset</button>
                <div class="zoom-controls">
                    <button class="button" id="zoomOut">-</button>
                    <span id="zoomLevel">100%</span>
                    <button class="button" id="zoomIn">+</button>
                </div>
                <div class="toolbar-right">
                    <div class="icon-info">
                        <span id="iconName"></span>
                        <span id="iconDimensions"></span>
                    </div>
                    <!-- <button class="button help-button" id="startTour">
                <span class="material-symbols-outlined">help_outline</span>
            </button> -->
                </div>
            </div>
        </div>

        <div class="workspace-content">
            <div class="icon-preview" id="iconPreview">
                <div id="previewSection">
                    <div class="preview-layers">
                        <span class="preview-icon primary"></span>
                        <span class="preview-icon secondary"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Working Icons Strip at bottom -->
        <div class="working-icons-strip">
            <div class="working-icons-header">
                <h3>Working Icons</h3>
                <div class="working-icons-options">
                    <div class="auto-update-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" id="autoUpdateIcons" />
                            <span class="toggle-slider"></span>
                            Auto Update
                        </label>
                    </div>

                    <div class="working-icons-options">
                        <label class="toggle-label">
                            <input type="checkbox" id="autoSaveIcons">
                            <span class="toggle-slider"></span>
                            Auto-save icons
                        </label>
                    </div>



                    <button class="button" id="exportAllIcons">Export All</button>
                </div>
            </div>
            <div class="working-icons-grid" id="workingIconsGrid">
                <!-- Working icons will be dynamically added here -->
            </div>
        </div>
    </main>

    <!-- </main> -->

    <!-- Right Panel - Controls -->
    <aside class="panel">
        <div class="panel-section">
            <h2 class="panel-title">Style</h2>
                <div class="color-pickers-row">
                    <div class="control-group">
                        <label>Primary Color</label>
                        <div id="primaryColorPicker"></div>
                    </div>
                    <button class="button swap-colors-btn" id="swapColorsBtn" title="Swap Primary/Secondary Colors">
                        <span class="material-symbols-outlined">swap_horiz</span>
                    </button>
                    <div class="control-group">
                        <label>Secondary Color</label>
                        <div id="secondaryPicker"></div>
                    </div>
                </div>

            </div>
        </div>

        <div class="panel-content">
            <!-- Material Controls -->
            <div class="panel-section material-controls">
                <h3>Properties</h3>
                <div class="control-group">
                    <label>Weight <span id="weightValue">400</span></label>
                    <input type="range" id="weightSlider" min="100" max="700" step="100" value="400" />
                </div>
                <div class="control-group">
                    <label>Fill <span id="fillValue">0</span></label>
                    <input type="range" id="fillSlider" min="0" max="1" step="1" value="0" />
                </div>
                <div class="control-group">
                    <label>Grade <span id="gradeValue">0</span></label>
                    <input type="range" id="gradeSlider" min="-50" max="200" step="1" value="0" />
                </div>
                <div class="control-group">
                    <label>Size <span id="sizeValue">24</span></label>
                    <input type="range" id="sizeSlider" min="20" max="48" step="4" value="24" />
                </div>
            </div>

            <!-- Font Awesome Controls -->
            <div class="panel-section fa-controls" style="display: none">
                <div class="control-group">
                    <label>Secondary Opacity <span id="opacityValue">0.4</span></label>
                    <input type="range" id="opacitySlider" min="0" max="1" step="0.1" value="0.4" />
                </div>
            </div>

            <!-- Common Controls -->
            <div class="panel-section">
                <h3>Effects</h3>
                <div class="control-group">
                    <label>Offset <span id="offsetValue">2</span>px</label>
                    <input type="range" id="offsetSlider" min="0" max="5" step="0.5" value="2" />
                </div>
                <div class="effect-options">
                    <button class="button effect-option" data-effect="shadow">
                        Drop Shadow
                    </button>
                    <button class="button effect-option" data-effect="glow">
                        Glow Effect
                    </button>
                    <!-- <button class="button effect-option" data-effect="gradient">
                        Gradient Fill
                    </button> -->

                    <div class="split-button">
                        <button class="button effect-option" data-effect="gradient">Gradient</button>
                        <button class="button dropdown-trigger">▼</button>
                        <div class="gradient-angles">
                            <button data-angle="top-right">↗️ Top Right</button>
                            <button data-angle="top-left">↖️ Top Left</button>
                            <button data-angle="bottom-right">↘️ Bottom Right</button>
                            <button data-angle="bottom-left">↙️ Bottom Left</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="panel-section">
                <h3>Export</h3>
                <div class="export-options">
                    <button class="button" id="copyCSSBtn">Copy CSS</button>
                    <button class="button" id="exportThemeBtn">Export Theme</button>
                    <button class="button" id="exportPNGBtn">Export PNG</button>
                    <button class="button" id="saveConfigBtn">
                        Save Configuration
                    </button>
                </div>
                <div class="code-preview">
                    <pre id="cssCode" class="code-block"></pre>
                </div>
            </div>
            <div class="panel-section">
                <!-- <h3>Saved Configurations</h3> -->
                <div class="saved-icons">
                    <!-- Saved configurations will appear here -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Hidden inputs for Pickr compatibility -->
    <input type="hidden" id="primaryColor" value="#000000" />
    <input type="hidden" id="secondaryColor" value="#666666" />

    <!-- Modals -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export Theme</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="themeCode" class="code-block"></pre>
            </div>
            <div class="modal-footer">
                <button class="button" id="copyThemeBtn">Copy</button>
                <button class="button" id="downloadThemeBtn">Download</button>
            </div>
        </div>
    </div>
</body>
<script>
    // Tour steps configuration
    const tourSteps = [
        {
            target: '.library-selector',
            content:
                'Start by choosing your icon library. Choose between Material Symbols or Font Awesome.',
            position: 'bottom'
        },
        {
            target: '.style-selector',
            content:
                'Select the style variant for your chosen library (Outlined, Rounded, etc.).',
            position: 'bottom'
        },
        {
            target: '.search-bar',
            content: 'Search for icons by name to find exactly what you need.',
            position: 'right'
        },
        {
            target: '.sidebar-content',
            content: 'Browse and click on any icon to select it for customization.',
            position: 'right'
        },
        {
            target: '.color-pickers-row',
            content: 'Choose primary and secondary colors for your icon.',
            position: 'left'
        },
        {
            target: '.effect-options',
            content:
                'Apply effects like shadows, glows, or gradients to enhance your icon.',
            position: 'left'
        },
        {
            target: '.workspace-content',
            content:
                'Preview your icon here. Use Ctrl + Mouse Wheel to zoom in/out.',
            position: 'middle'
        },
        {
            target: '.export-options',
            content:
                'Export your customized icon as CSS, or save your configuration for later.',
            position: 'left'
        }
    ]

    class Tour {
        constructor(steps) {
            this.steps = steps
            this.currentStep = 0
            this.overlay = null
            this.tooltip = null
        }

        start() {
            this.createOverlay()
            this.showStep(0)
        }

        createOverlay() {
            this.overlay = document.createElement('div')
            this.overlay.className = 'tour-overlay'
            document.body.appendChild(this.overlay)
        }

        showStep(index) {
            if (index >= this.steps.length) {
                this.end()
                return
            }

            const step = this.steps[index]
            const target = document.querySelector(step.target)

            if (!target) {
                console.error(`Target not found: ${step.target}`)
                return
            }

            // Create highlight
            const highlight = document.createElement('div')
            highlight.className = 'tour-highlight'
            const rect = target.getBoundingClientRect()
            Object.assign(highlight.style, {
                top: `${rect.top}px`,
                left: `${rect.left}px`,
                width: `${rect.width}px`,
                height: `${rect.height}px`
            })
            document.body.appendChild(highlight)

            // Create tooltip
            if (this.tooltip) {
                this.tooltip.remove()
            }

            this.tooltip = document.createElement('div')
            this.tooltip.className = 'tour-tooltip'
            this.tooltip.innerHTML = `
            <div>${step.content}</div>
            <div class="tour-tooltip-buttons">
                ${index > 0
                    ? '<button class="button" id="prevStep">Previous</button>'
                    : ''
                }
                <button class="button" id="nextStep">
                    ${index === this.steps.length - 1 ? 'Finish' : 'Next'}
                </button>
            </div>
        `

            // Position tooltip
            const tooltipRect = {
                top: rect.top,
                left: rect.left,
                width: 300, // max-width from CSS
                height: 100 // approximate
            }

            switch (step.position) {
                case 'bottom':
                    tooltipRect.top = rect.bottom + 10
                    tooltipRect.left = rect.left + (rect.width - tooltipRect.width) / 2
                    break
                case 'top':
                    tooltipRect.top = rect.top - tooltipRect.height - 10
                    tooltipRect.left = rect.left + (rect.width - tooltipRect.width) / 2
                    break
                case 'left':
                    tooltipRect.top = rect.top + (rect.height - tooltipRect.height) / 2
                    tooltipRect.left = rect.left - tooltipRect.width - 10
                    break
                case 'right':
                    tooltipRect.top = rect.top + (rect.height - tooltipRect.height) / 2
                    tooltipRect.left = rect.right + 10
                    break
            }

            Object.assign(this.tooltip.style, {
                top: `${tooltipRect.top}px`,
                left: `${tooltipRect.left}px`
            })

            document.body.appendChild(this.tooltip)

            // Add event listeners
            const nextBtn = this.tooltip.querySelector('#nextStep')
            const prevBtn = this.tooltip.querySelector('#prevStep')

            if (nextBtn) {
                nextBtn.addEventListener('click', () => this.next())
            }
            if (prevBtn) {
                prevBtn.addEventListener('click', () => this.prev())
            }
        }

        next() {
            this.currentStep++
            this.showStep(this.currentStep)
        }

        prev() {
            this.currentStep--
            this.showStep(this.currentStep)
        }

        end() {
            if (this.overlay) {
                this.overlay.remove()
            }
            if (this.tooltip) {
                this.tooltip.remove()
            }
            document.querySelectorAll('.tour-highlight').forEach(el => el.remove())
        }
    }

    // Add to your initialization code
    document.getElementById('startTour').addEventListener('click', () => {
        const tour = new Tour(tourSteps)
        tour.start()
    })

    // Global state
    let selectedIcon = null
    let currentLibrary = 'material'
    let currentFamily = 'outlined'
    let zoomLevel = 100
    let primaryPickr, secondaryPickr; 

const GRADIENT_ANGLES = {
    'bottom-left': { start: [0, 0], end: [1, 1] },        // 45 degrees - bottom right x
    'top-left': { start: [1, 0], end: [0, 1] },         // 135 degrees - bottom left x
    'bottom-right': { start: [0, 1], end: [1, 0] },     // -45 degrees - top right x
    'top-right': { start: [1, 1], end: [0, 0] }       // -135 degrees - top left
};

const GRADIENT_DIRECTIONS = {
    'bottom-left': { angle: 45, coords: { start: [0, 0], end: [1, 1] } },
    'top-left': { angle: 135, coords: { start: [1, 0], end: [0, 1] } },
    'bottom-right': { angle: 315, coords: { start: [0, 1], end: [1, 0] } },
    'top-right': { angle: 225, coords: { start: [1, 1], end: [0, 0] } }
};

let currentGradientAngle = 'top-right'; // Default


    // Working Icons Manager
    class WorkingIconsManager {
        constructor() {
            this.icons = new Map()
            this.autoUpdate = false
        }

        generateIdentifier(config) {
            return `${config.library}-${config.family}-${config.icon}-${new Date().toISOString().split('T')[0]
                }`
        }

        addOrUpdateIcon(config) {
        const identifier = this.generateIdentifier(config);

        if (this.icons.has(identifier) && !this.autoUpdate) {
            if (!confirm('Update existing icon configuration?')) {
                return false;
            }
        }

        this.icons.set(identifier, {
            ...config,
            gradientAngle: currentGradientAngle,
            timestamp: Date.now()
        });

        this.updateDisplay();
        return true;
    }

    updateWithoutConfirm(config) {
        const identifier = this.generateIdentifier(config);
        this.icons.set(identifier, {
            ...config,
            gradientAngle: currentGradientAngle,
            timestamp: Date.now()
        });
        this.updateDisplay();
    }

        loadIcon(identifier) {
            const config = this.icons.get(identifier)
            if (config) {
                // Store current icon before loading new one
                if (selectedIcon) {
                    const currentConfig = getCurrentConfiguration()
                    const currentIdentifier = this.generateIdentifier(currentConfig)
                    if (currentIdentifier !== identifier) {
                        this.addOrUpdateIcon(currentConfig)
                    }
                }

                // Load the selected configuration
                loadConfiguration(config)
                selectedIcon = config.icon
                updatePreview()
            }
        }

        removeIcon(identifier) {
            this.icons.delete(identifier)
            this.updateDisplay()
        }

        exportAllIcons() {
            let css = '/* Icon Studio - Bulk Export */\n\n'
            this.icons.forEach((config, identifier) => {
                css += `/* ${config.icon} */\n`
                if (config.library === 'material') {
                    css += generateMaterialThemeCSS(config)
                } else {
                    css += generateFontAwesomeThemeCSS(config)
                }
                css += '\n\n'
            })
            return css
        }

        updateDisplay() {
            const grid = document.getElementById('workingIconsGrid')
            if (!grid) return

            grid.innerHTML = ''

            this.icons.forEach((config, identifier) => {
                const iconElement = this.createIconElement(config, identifier)
                grid.appendChild(iconElement)
            })
        }

        createIconElement(config, identifier) {
            const div = document.createElement('div')
            div.className = 'working-icon'
            div.innerHTML = `
        <div class="icon-preview">
            ${config.library === 'material'
                    ? `<span class="material-symbols-${config.family}" 
                     style="color: ${config.primaryColor}">${config.icon}</span>`
                    : `<i class="fa-${config.family} fa-${config.icon}" 
                     style="color: ${config.primaryColor}"></i>`
                }
        </div>
        <span class="icon-name" data-name="${config.icon}">${config.icon}</span>
        <button class="remove-icon" title="Remove">×</button>
    `

            // Add tooltip to show full configuration on hover
            div.title = `${config.icon}\nPrimary: ${config.primaryColor}\nSecondary: ${config.secondaryColor}`

            div.querySelector('.remove-icon').onclick = e => {
                e.stopPropagation()
                this.removeIcon(identifier)
            }

            div.onclick = () => this.loadIcon(identifier)
            return div
        }
    }

    // Initialize working icons manager
    const workingIconsManager = new WorkingIconsManager()

    // Icon libraries

    let iconLibraries = {
        material: [], // We can start with empty arrays
        fa: {}
    }

    // initialization code
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            const iconsLoaded = await loadIcons()
            if (iconsLoaded) {
                initializeColorPickers();
                initializeSavedConfigs();
                initializeModals();
                initializeLibrarySelectors();
                initializeIconGrid();
                initializeEventListeners();
                initializeQuickFeatures();
                initializeGradientControls();
            }
        } catch (error) {
            console.error('Initialization error:', error)
        }
    })

    async function loadFontAwesomeIcons() {
        try {
            const response = await fetch('fa_free_icons.json')
            const faIcons = await response.json()
            iconLibraries.fa = faIcons
            console.log('Font Awesome icons loaded successfully')
        } catch (error) {
            console.error('Error loading Font Awesome icons:', error)
        }
    }

    async function loadIcons() {
        const loadingOverlay = document.getElementById('loadingOverlay')
        const loadingText = loadingOverlay.querySelector('.loading-text')

        try {
            loadingText.textContent = 'Loading Material Icons...'
            const materialResponse = await fetch('material_icons.json')
            const materialData = await materialResponse.json()

            loadingText.textContent = 'Loading Font Awesome Icons...'
            const faResponse = await fetch('fa_free_icons.json')
            const faData = await faResponse.json()

            // Update iconLibraries object
            iconLibraries = {
                material: materialData.material,
                fa: faData
            }

            loadingText.textContent = 'Initializing...'

            // Verify data integrity
            if (!iconLibraries.material || !iconLibraries.fa) {
                throw new Error('Icon data is incomplete')
            }

            console.log('Icons loaded successfully:', {
                material: iconLibraries.material.length,
                fa: {
                    solid: iconLibraries.fa.solid.length,
                    regular: iconLibraries.fa.regular.length,
                    brands: iconLibraries.fa.brands.length
                }
            })

            // Hide loading overlay with fade effect
            loadingOverlay.style.opacity = '0'
            setTimeout(() => {
                loadingOverlay.style.display = 'none'
            }, 500)

            return true
        } catch (error) {
            console.error('Error loading icons:', error)
            loadingText.textContent =
                'Error loading icons. Please refresh the page.'
            loadingOverlay.classList.add('error')
            return false
        }
    }

    function updateIconCount() {
    const dropdown = document.getElementById('librarySelect');
    const countDisplay = document.getElementById('iconCount');
    const selected = dropdown.value;
    const [library, family] = selected.split('-');

    let count;
    if (library === 'material') {
        count = `${iconLibraries.material.length} Material icons`;
    } else {
        count = `${iconLibraries.fa[family].length} Font Awesome ${family} icons`;
    }

    // For the badge version
    if (countDisplay) {
        countDisplay.textContent = count;
    }
}

    function initializeLibrarySelectors() {
        // Populate style selector based on current library
        const styleSelector = document.querySelector('.style-selector')

        const materialStyles = [
            { family: 'outlined', label: 'Outlined' },
            { family: 'rounded', label: 'Rounded' },
            { family: 'sharp', label: 'Sharp' }
        ]

        const faStyles = [
            { family: 'solid', label: 'Solid' },
            { family: 'regular', label: 'Regular' },
            { family: 'light', label: 'Light' },
            { family: 'duotone', label: 'Duotone' }
        ]

        function updateStyleButtons(library) {
            const styles = library === 'material' ? materialStyles : faStyles
            styleSelector.innerHTML = styles
                .map(
                    style => `
            <button class="button${currentFamily === style.family ? ' active' : ''
                        }" 
                    data-family="${style.family}">
                ${style.label}
            </button>
        `
                )
                .join('')

            // Add click handlers
            styleSelector.querySelectorAll('.button').forEach(button => {
                button.addEventListener('click', () => {
                    currentFamily = button.dataset.family
                    styleSelector
                        .querySelectorAll('.button')
                        .forEach(btn => btn.classList.toggle('active', btn === button))
                    initializeIconGrid()
                    if (selectedIcon) updatePreview()
                })
            })
        }

        // Initial setup
        updateStyleButtons(currentLibrary)
    }

function initializeGradientControls() {
    const dropdownTrigger = document.querySelector('.split-button .dropdown-trigger');
    const gradientAngles = document.querySelector('.gradient-angles');

    // Toggle dropdown
    dropdownTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        gradientAngles.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        gradientAngles.classList.remove('active');
    });

    // Handle angle selection
    gradientAngles.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
            currentGradientAngle = button.dataset.angle;

            if (selectedIcon) {
                // Just update preview - it handles everything now
                updatePreview();

                // Silently update working icons without confirmation
                const config = getCurrentConfiguration();
                config.gradientAngle = currentGradientAngle;
                workingIconsManager.updateWithoutConfirm(config);
            }
            
            gradientAngles.classList.remove('active');
        }
    });
}


    function initializeQuickFeatures() {
    document.getElementById('swapColorsBtn').addEventListener('click', () => {
        const primaryColor = document.getElementById('primaryColor').value;
        const secondaryColor = document.getElementById('secondaryColor').value;
        
        // Swap colors using our stored Pickr instances
        primaryPickr.setColor(secondaryColor);
        secondaryPickr.setColor(primaryColor);
        
        // Update hidden inputs
        document.getElementById('primaryColor').value = secondaryColor;
        document.getElementById('secondaryColor').value = primaryColor;
        
        // Update preview
        updatePreview();
    });

    // Auto-save toggle
    const autoSaveCheckbox = document.getElementById('autoSaveIcons');
    autoSaveCheckbox.checked = localStorage.getItem('autoSaveIcons') === 'true';
    
    autoSaveCheckbox.addEventListener('change', (e) => {
        localStorage.setItem('autoSaveIcons', e.target.checked);
    });
}

    // Color picker initialization
    function initializeColorPickers() {
        try {
            // Primary color picker
             primaryPickr = Pickr.create({
                el: '#primaryColorPicker',
                theme: 'nano',
                default: '#000000',
                swatches: [
                    '#000000',
                    '#FFFFFF',
                    '#2196F3',
                    '#E91E63',
                    '#4CAF50',
                    '#FFC107',
                    '#9C27B0',
                    '#795548',
                    '#607D8B'
                ],
                components: {
                    preview: true,
                    opacity: true,
                    hue: true,
                    interaction: {
                        hex: true,
                        rgba: true,
                        input: true,
                        save: true
                    }
                }
            })

            // Secondary color picker
             secondaryPickr = Pickr.create({
                el: '#secondaryPicker',
                theme: 'nano',
                default: '#666666',
                swatches: [
                    '#000000',
                    '#FFFFFF',
                    '#2196F3',
                    '#E91E63',
                    '#4CAF50',
                    '#FFC107',
                    '#9C27B0',
                    '#795548',
                    '#607D8B'
                ],
                components: {
                    preview: true,
                    opacity: true,
                    hue: true,
                    interaction: {
                        hex: true,
                        rgba: true,
                        input: true,
                        save: true
                    }
                }
            })

            // Handle color changes
            if (primaryPickr) {
                primaryPickr.on('change', color => {
                    document.getElementById('primaryColor').value = color
                        .toHEXA()
                        .toString()
                    updatePreview()
                })
            }

            if (secondaryPickr) {
                secondaryPickr.on('change', color => {
                    document.getElementById('secondaryColor').value = color
                        .toHEXA()
                        .toString()
                    updatePreview()
                })
            }
        } catch (error) {
            console.error('Color picker initialization failed:', error)
        }
    }


    function initializeIconGrid() {
    const grid = document.getElementById('iconGrid');
    grid.innerHTML = ''; // Clear existing icons
    
    if (currentLibrary === 'material') {
        iconLibraries.material.forEach(icon => {
            createIconElement(icon, 'material', grid);  // Pass grid as parameter
        });
    } else {
        // Get the correct FA icon list based on family
        const icons = iconLibraries.fa[currentFamily] || [];
        icons.forEach(icon => {
            createIconElement(icon, 'fa', grid);  // Pass grid as parameter
        });
    }
}

function createIconElement(icon, library, grid) {  // Add grid parameter
    const div = document.createElement('div');
    div.className = 'icon-item';
    
    if (library === 'material') {
        div.innerHTML = `
            <span class="material-symbols-${currentFamily}">${icon}</span>
            <span class="icon-name">${icon}</span>
        `;
    } else {
        const prefix = getFAPrefix(currentFamily);
        div.innerHTML = `
            <i class="${prefix} fa-${icon}"></i>
            <span class="icon-name">${icon}</span>
        `;
    }
    
    div.addEventListener('click', () => selectIcon(icon, div));
    grid.appendChild(div);
}

    function getFAPrefix(family) {
        switch (family) {
            case 'solid':
                return 'fas'
            case 'regular':
                return 'far'
            case 'brands':
                return 'fab'
            default:
                return 'fas'
        }
    }

    function initializeEventListeners() {
        // Library and style selectors
        document.querySelectorAll('.library-selector .button').forEach(button => {
            button.addEventListener('click', () => {
                const library = button.dataset.library
                switchLibrary(library)
            })
        })

        // Sliders
        document.getElementById('weightSlider').addEventListener('input', e => {
            document.getElementById('weightValue').textContent = e.target.value
            updatePreview()
        })

        document.getElementById('fillSlider').addEventListener('input', e => {
            document.getElementById('fillValue').textContent = e.target.value
            updatePreview()
        })

        document.getElementById('gradeSlider').addEventListener('input', e => {
            document.getElementById('gradeValue').textContent = e.target.value
            updatePreview()
        })

        document.getElementById('sizeSlider').addEventListener('input', e => {
            document.getElementById('sizeValue').textContent = e.target.value
            updatePreview()
        })

        document.getElementById('offsetSlider').addEventListener('input', e => {
            document.getElementById('offsetValue').textContent = e.target.value
            updatePreview()
        })

        document.getElementById('opacitySlider').addEventListener('input', e => {
            document.getElementById('opacityValue').textContent = e.target.value
            updatePreview()
        })

        // Effect buttons
        document.querySelectorAll('.effect-option').forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('active')
                updatePreview()
            })
        })

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', e => {
            const searchTerm = e.target.value.toLowerCase()
            document.querySelectorAll('.icon-item').forEach(item => {
                const iconName = item.querySelector('.icon-name').textContent
                item.style.display = iconName.includes(searchTerm) ? 'flex' : 'none'
            })
        })

        // Workspace controls
        document
            .getElementById('toggleBackground')
            .addEventListener('click', () => {
                const preview = document.getElementById('iconPreview')
                preview.classList.toggle('dark-bg')
            })

        document.getElementById('zoomIn').addEventListener('click', () => {
            zoomLevel = Math.min(zoomLevel + 25, 200)
            updateZoom()
        })

        document.getElementById('zoomOut').addEventListener('click', () => {
            zoomLevel = Math.max(zoomLevel - 25, 50)
            updateZoom()
        })

        document.getElementById('exportPNGBtn').addEventListener('click', () => {
            // Get current size setting or use default
            const size = parseInt(document.getElementById('sizeSlider').value) * 2
            exportAsPNG(size)
        })

        // Working icons controls
        const autoUpdateToggle = document.getElementById('autoUpdateIcons')
        if (autoUpdateToggle) {
            autoUpdateToggle.addEventListener('change', e => {
                workingIconsManager.autoUpdate = e.checked
            })
        }

        const exportAllBtn = document.getElementById('exportAllIcons')
        if (exportAllBtn) {
            exportAllBtn.addEventListener('click', () => {
                const css = workingIconsManager.exportAllIcons()
                const filename = `icon-studio-theme-all-${new Date().toISOString().split('T')[0]
                    }.css`
                downloadFile(css, filename, 'text/css')
            })
        }

        document
            .getElementById('librarySelect')
            .addEventListener('change', function (e) {
                const [library, family] = e.target.value.split('-')
                currentLibrary = library
                currentFamily = family

                // Update icon grid
                initializeIconGrid();
                updateIconCount();

                // Clear current selection
                selectedIcon = null
                const previewSection = document.getElementById('previewSection')
                if (previewSection) {
                    previewSection.style.display = 'none'
                }
            })

        // Export buttons
        document.getElementById('copyCSSBtn').addEventListener('click', copyCSS)
        document
            .getElementById('exportThemeBtn')
            .addEventListener('click', showExportModal)
        document
            .getElementById('saveConfigBtn')
            .addEventListener('click', saveConfiguration)

        document.querySelector('.workspace-content').addEventListener(
            'wheel',
            e => {
                // Prevent default scroll
                e.preventDefault()

                // Only zoom if Ctrl key is pressed
                if (e.ctrlKey || e.metaKey) {
                    // Zoom out
                    if (e.deltaY > 0) {
                        zoomLevel = Math.max(zoomLevel - 10, 50)
                    }
                    // Zoom in
                    else {
                        zoomLevel = Math.min(zoomLevel + 10, 200)
                    }

                    updateZoom()
                }
            },
            { passive: false }
        )
    }

    function switchLibrary(library) {
        currentLibrary = library

        // Update library buttons
        document.querySelectorAll('.library-selector .button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.library === library)
        })

        // Show/hide library specific controls
        const materialControls = document.querySelector('.material-controls')
        const faControls = document.querySelector('.fa-controls')

        if (materialControls) {
            materialControls.style.display =
                library === 'material' ? 'block' : 'none'
        }
        if (faControls) {
            faControls.style.display = library === 'fa' ? 'block' : 'none'
        }

        // Update style selector
        initializeLibrarySelectors()

        // Reset family to default for new library
        currentFamily = library === 'material' ? 'outlined' : 'solid'

        // Update icon grid
        initializeIconGrid()

        // Clear selection
        selectedIcon = null

        const previewSection = document.getElementById('previewSection')
        if (previewSection) {
            previewSection.style.display = 'none'
        }
    }

    // Select an icon
    function selectIcon(icon, element) {
        try {
            // Store current icon if one exists
            if (selectedIcon) {
                const currentConfig = getCurrentConfiguration()
                workingIconsManager.addOrUpdateIcon(currentConfig)
            }



                    // Store current icon if auto-save is enabled
        if (selectedIcon && document.getElementById('autoSaveIcons').checked) {
            const currentConfig = getCurrentConfiguration();
            workingIconsManager.addOrUpdateIcon(currentConfig);
        }

            // Remove previous selection
            document
                .querySelectorAll('.icon-item.selected')
                .forEach(item => item.classList.remove('selected'))

            // Add selection to clicked icon
            // element.classList.add('selected')
            // selectedIcon = icon

            selectedIcon = icon;
            element.classList.add('selected');

            const newConfig = getCurrentConfiguration();
            workingIconsManager.addOrUpdateIcon(newConfig);

            // Update preview and info
            updatePreview()
            const iconNameElement = document.getElementById('iconName')
            if (iconNameElement) {
                iconNameElement.textContent = icon
            }

            const previewSection = document.getElementById('previewSection')
            if (previewSection) {
                previewSection.style.display = 'block'
            }
        } catch (error) {
            console.error('Error in selectIcon:', error)
        }
    }

    function updatePreview() {
    if (!selectedIcon) return;

    const previewSection = document.getElementById('previewSection');
    if (!previewSection) return;

    // Get active effects
    const effects = Array.from(document.querySelectorAll('.effect-option.active'))
        .map(opt => opt.dataset.effect);

    const primaryIcon = document.querySelector('.preview-icon.primary');
    const secondaryIcon = document.querySelector('.preview-icon.secondary');
    if (!primaryIcon || !secondaryIcon) return;

    const weight = document.getElementById('weightSlider').value;
    const fill = document.getElementById('fillSlider').value;
    const grade = document.getElementById('gradeSlider').value;
    const size = document.getElementById('sizeSlider').value;
    const offset = document.getElementById('offsetSlider').value;
    const primaryColor = document.getElementById('primaryColor').value;
    const secondaryColor = document.getElementById('secondaryColor').value;
    const opacity = document.getElementById('opacitySlider').value;

    // Clear previous icons and styles
    primaryIcon.className = 'preview-icon primary';
    secondaryIcon.className = 'preview-icon secondary';
    primaryIcon.style = '';
    secondaryIcon.style = '';

    if (currentLibrary === 'material') {
        const baseClass = `material-symbols-${currentFamily}`;
        primaryIcon.className = `${baseClass} preview-icon primary`;
        secondaryIcon.className = `${baseClass} preview-icon secondary`;

        primaryIcon.textContent = selectedIcon;
        secondaryIcon.textContent = selectedIcon;

        const variationSettings = `'FILL' ${fill}, 'wght' ${weight}, 'GRAD' ${grade}, 'opsz' ${size}`;
        primaryIcon.style.fontVariationSettings = variationSettings;
        secondaryIcon.style.fontVariationSettings = variationSettings;
    } else {
        const baseClass = `fa-${currentFamily} fa-${selectedIcon}`;
        primaryIcon.innerHTML = `<i class="${baseClass}"></i>`;
        secondaryIcon.innerHTML = `<i class="${baseClass}"></i>`;
    }

    // Handle gradient effect first
    if (effects.includes('gradient')) {
        const direction = GRADIENT_DIRECTIONS[currentGradientAngle];
        if (direction) {
            primaryIcon.style.background = `linear-gradient(${direction.angle}deg, ${primaryColor}, ${secondaryColor})`;
            primaryIcon.style.webkitBackgroundClip = 'text';
            primaryIcon.style.webkitTextFillColor = 'transparent';
            secondaryIcon.style.opacity = '0';
        }
    } else {
        // Regular two-tone effect
        primaryIcon.style.color = primaryColor;
        secondaryIcon.style.color = secondaryColor;
        secondaryIcon.style.transform = `translate(${offset}px, ${offset}px)`;
        secondaryIcon.style.opacity = opacity;
    }

    // Apply other effects last
    if (!effects.includes('gradient')) {
        applyEffects(primaryIcon, secondaryIcon, effects);
    }
    
    updateCSS();
}

    // Helper function to calculate CSS angle
function calculateCSSAngle(start, end) {
    // Map gradient coordinates to CSS angles

    const angleMap = {
        'bottom-left': 45,  // [0,0] to [1,1]
        'top-left': 135,  // [1,0] to [0,1]
        'bottom-right': 315,    // [0,1] to [1,0]
        'top-right': 225      // [1,1] to [0,0]
    };
    
    // Find the matching angle
    for (const [direction, coords] of Object.entries(GRADIENT_ANGLES)) {
        if (coords.start[0] === start[0] && 
            coords.start[1] === start[1] && 
            coords.end[0] === end[0] && 
            coords.end[1] === end[1]) {
            return angleMap[direction];
        }
    }
    return 45; // Default angle
}

    // Effect application functions
    function applyEffects(primaryIcon, secondaryIcon, activeEffects) {
        // Get colors at the start
        const primaryColorEl = document.getElementById('primaryColor')
        const secondaryColorEl = document.getElementById('secondaryColor')

        const primaryColor = primaryColorEl ? primaryColorEl.value : '#000000'
        const secondaryColor = secondaryColorEl
            ? secondaryColorEl.value
            : '#666666'

            // Reset existing effects
            ;[primaryIcon, secondaryIcon].forEach(icon => {
                if (!icon) return
                icon.style.filter = ''
                icon.style.background = ''
                icon.style.webkitBackgroundClip = ''
                icon.style.webkitTextFillColor = ''
            })

        // Apply each active effect
        activeEffects.forEach(effect => {
            if (!primaryIcon) return

            switch (effect) {
                case 'shadow':
                    primaryIcon.style.filter =
                        'drop-shadow(2px 2px 2px rgba(0,0,0,0.3))'
                    break

                case 'glow':
                    primaryIcon.style.filter = `drop-shadow(0 0 5px ${primaryColor})`
                    break

                case 'gradient':
                    primaryIcon.style.background = `linear-gradient(45deg, ${primaryColor}, ${secondaryColor})`
                    primaryIcon.style.webkitBackgroundClip = 'text'
                    primaryIcon.style.webkitTextFillColor = 'transparent'
                    // Remove secondary icon when gradient is active
                    if (secondaryIcon) {
                        secondaryIcon.style.opacity = '0'
                    }
                    break
            }
        })
    }

    function updateGradientAngle(angle) {
    currentGradientAngle = angle;
    updatePreview();
    // Update working icon if it matches current
    if (selectedIcon) {
        const config = getCurrentConfiguration();
        config.gradientAngle = angle;
        workingIconsManager.addOrUpdateIcon(config);
    }
}

    // Zoom functionality
    function updateZoom() {
        const preview = document.querySelector('.preview-layers')
        preview.style.transform = `scale(${zoomLevel / 100})`
        document.getElementById('zoomLevel').textContent = `${zoomLevel}%`
    }

    // Background toggle helper
    function updateBackground(isDark) {
        const preview = document.getElementById('iconPreview')
        preview.style.background = isDark ? '#1a1a1a' : '#ffffff'
    }

    // Effect helper functions
    function getEffectStyles(effects) {
        const styles = []
        const primaryColor = document.getElementById('primaryColor').value
        const secondaryColor = document.getElementById('secondaryColor').value

        effects.forEach(effect => {
            switch (effect) {
                case 'shadow':
                    styles.push('filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));')
                    break
                case 'glow':
                    styles.push(`filter: drop-shadow(0 0 5px ${primaryColor});`)
                    break
                case 'gradient':
                    styles.push(`
                    background: linear-gradient(45deg, ${primaryColor}, ${secondaryColor});
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                `)
                    break
            }
        })

        return styles.join('\n    ')
    }

    // CSS Generation Functions
    function updateCSS() {
        if (!selectedIcon) return

        const weight = document.getElementById('weightSlider').value
        const fill = document.getElementById('fillSlider').value
        const grade = document.getElementById('gradeSlider').value
        const size = document.getElementById('sizeSlider').value
        const offset = document.getElementById('offsetSlider').value
        const primaryColor = document.getElementById('primaryColor').value
        const secondaryColor = document.getElementById('secondaryColor').value
        const opacity = document.getElementById('opacitySlider').value

        const activeEffects = Array.from(
            document.querySelectorAll('.effect-option.active')
        ).map(opt => opt.dataset.effect)

        let css = ''

        if (currentLibrary === 'material') {
            css = generateMaterialCSS(
                selectedIcon,
                { weight, fill, grade, size, offset, primaryColor, secondaryColor },
                activeEffects
            )
        } else {
            css = generateFontAwesomeCSS(
                selectedIcon,
                { primaryColor, secondaryColor, offset, opacity },
                activeEffects
            )
        }

        document.getElementById('cssCode').textContent = css
    }

    function generateMaterialCSS(icon, options, effects) {
        const className = `material-symbols-${currentFamily}`
        const iconName = icon.replace(/_/g, '-')

        let css = `/* Material Symbols Icon Styles */
.${className}.icon-${iconName} {
    font-variation-settings: 
        'FILL' ${options.fill},
        'wght' ${options.weight},
        'GRAD' ${options.grade},
        'opsz' ${options.size};
    color: ${options.primaryColor};
    position: relative;
    display: inline-block;
}

/* Two-tone effect */
.${className}.icon-${iconName}::after {
    content: "${icon}";
    position: absolute;
    left: ${options.offset}px;
    top: ${options.offset}px;
    color: ${options.secondaryColor};
    z-index: -1;
    font-variation-settings: 
        'FILL' ${options.fill},
        'wght' ${options.weight},
        'GRAD' ${options.grade},
        'opsz' ${options.size};
}`

        // Add effects if any are active
        if (effects.length > 0) {
            css += '\n\n/* Applied effects */\n'
            css += `.${className}.icon-${iconName} {\n    ${getEffectStyles(
                effects
            )}\n}`
        }

        return css
    }

    function generateFontAwesomeCSS(icon, options, effects) {
        const className = `fa-${currentFamily}`
        const iconName = icon.replace(/_/g, '-')

        let css = `/* Font Awesome Icon Styles */
.${className}.fa-${iconName}-wrapper {
    position: relative;
    display: inline-block;
}

.${className}.fa-${iconName} {
    color: ${options.primaryColor};
}

/* Two-tone effect */
.${className}.fa-${iconName}-secondary {
    position: absolute;
    left: ${options.offset}px;
    top: ${options.offset}px;
    color: ${options.secondaryColor};
    opacity: ${options.opacity};
    z-index: -1;
}`

        // Add effects if any are active
        if (effects.length > 0) {
            css += '\n\n/* Applied effects */\n'
            css += `.${className}.fa-${iconName} {\n    ${getEffectStyles(
                effects
            )}\n}`
        }

        return css
    }

    // Helper Functions
    function sanitizeIconName(name) {
        return name.replace(/[^a-zA-Z0-9-_]/g, '').toLowerCase()
    }

    function debounce(func, wait) {
        let timeout
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout)
                func(...args)
            }
            clearTimeout(timeout)
            timeout = setTimeout(later, wait)
        }
    }

    function hexToRgba(hex, opacity = 1) {
        let r = parseInt(hex.slice(1, 3), 16),
            g = parseInt(hex.slice(3, 5), 16),
            b = parseInt(hex.slice(5, 7), 16)
        return `rgba(${r}, ${g}, ${b}, ${opacity})`
    }

    function getIconDimensions(iconElement) {
        const rect = iconElement.getBoundingClientRect()
        return {
            width: Math.round(rect.width),
            height: Math.round(rect.height)
        }
    }

    function formatCSSValue(value, unit = '') {
        return typeof value === 'number' ? `${value}${unit}` : value
    }

    function validateConfiguration(config) {
        const requiredFields = [
            'library',
            'family',
            'icon',
            'primaryColor',
            'secondaryColor'
        ]
        return requiredFields.every(field => config.hasOwnProperty(field))
    }

    function getCurrentConfiguration() {
        return {
            library: currentLibrary,
            family: currentFamily,
            icon: selectedIcon,
            primaryColor: document.getElementById('primaryColor').value,
            secondaryColor: document.getElementById('secondaryColor').value,
            weight: parseInt(document.getElementById('weightSlider').value),
            fill: parseInt(document.getElementById('fillSlider').value),
            grade: parseInt(document.getElementById('gradeSlider').value),
            size: parseInt(document.getElementById('sizeSlider').value),
            offset: parseFloat(document.getElementById('offsetSlider').value),
            opacity: parseFloat(document.getElementById('opacitySlider').value),
            effects: Array.from(
                document.querySelectorAll('.effect-option.active')
            ).map(opt => opt.dataset.effect)
        }
    }

    function setSliderValue(sliderId, value, updateUI = true) {
        const slider = document.getElementById(sliderId)
        slider.value = value
        if (updateUI) {
            const valueDisplay = document.getElementById(
                `${sliderId.replace('Slider', '')}Value`
            )
            if (valueDisplay) {
                valueDisplay.textContent = value
            }
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div')
        notification.className = `notification ${type}`
        notification.textContent = message
        document.body.appendChild(notification)

        setTimeout(() => {
            notification.classList.add('show')
            setTimeout(() => {
                notification.classList.remove('show')
                setTimeout(() => notification.remove(), 300)
            }, 2000)
        }, 100)
    }

    function generateUniqueId() {
        return `icon-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
    }

    function isValidColor(color) {
        const s = new Option().style
        s.color = color
        return s.color !== ''
    }

    function copyToClipboard(text) {
        // Modern browsers
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard
                .writeText(text)
                .then(() => showNotification('Copied to clipboard!'))
                .catch(err =>
                    showNotification('Failed to copy to clipboard', 'error')
                )
        }

        // Fallback for older browsers
        const textarea = document.createElement('textarea')
        textarea.value = text
        textarea.style.position = 'fixed'
        textarea.style.opacity = '0'
        document.body.appendChild(textarea)
        textarea.select()

        try {
            document.execCommand('copy')
            document.body.removeChild(textarea)
            showNotification('Copied to clipboard!')
        } catch (err) {
            document.body.removeChild(textarea)
            showNotification('Failed to copy to clipboard', 'error')
        }
    }

    function downloadFile(content, filename, type = 'text/plain') {
        const blob = new Blob([content], { type })
        const url = URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = filename
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        URL.revokeObjectURL(url)
    }

    function getPreferredColorScheme() {
        if (
            window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches
        ) {
            return 'dark'
        }
        return 'light'
    }

    // Error handling helper
    function handleError(error, fallback) {
        console.error(error)
        if (typeof fallback === 'function') {
            try {
                fallback()
            } catch (fallbackError) {
                showNotification('An error occurred', 'error')
            }
        } else {
            showNotification('An error occurred', 'error')
        }
    }

    // Save and Load Functions
    function saveConfiguration() {
        try {
            const config = getCurrentConfiguration()
            const savedConfigs = getSavedConfigurations()
            const configId = generateUniqueId()

            // Add new configuration
            savedConfigs[configId] = {
                ...config,
                name: `${config.icon} - ${new Date().toLocaleDateString()}`,
                timestamp: Date.now()
            }

            // Save to localStorage
            localStorage.setItem('iconStudioConfigs', JSON.stringify(savedConfigs))

            // Update saved configurations display
            updateSavedConfigsList()
            showNotification('Configuration saved successfully!')
        } catch (error) {
            handleError(error)
        }
    }

    function getSavedConfigurations() {
        try {
            const saved = localStorage.getItem('iconStudioConfigs')
            return saved ? JSON.parse(saved) : {}
        } catch (error) {
            handleError(error)
            return {}
        }
    }

    function loadConfiguration(configId) {
        try {
            const savedConfigs = getSavedConfigurations()
            const config = savedConfigs[configId]

            if (!validateConfiguration(config)) {
                throw new Error('Invalid configuration')
            }

            // Switch library if needed
            if (config.library !== currentLibrary) {
                switchLibrary(config.library)
            }

            // Update family if needed
            if (config.family !== currentFamily) {
                currentFamily = config.family
                updateFamilyButtons()
            }

            // Set colors
            document.getElementById('primaryColor').value = config.primaryColor
            document.getElementById('secondaryColor').value = config.secondaryColor

            // Update color pickers
            const primaryPickr = Pickr.getInstance('#primaryColorPicker')
            const secondaryPickr = Pickr.getInstance('#secondaryPicker')
            if (primaryPickr) primaryPickr.setColor(config.primaryColor)
            if (secondaryPickr) secondaryPickr.setColor(config.secondaryColor)

            // Set slider values
            setSliderValue('weightSlider', config.weight)
            setSliderValue('fillSlider', config.fill)
            setSliderValue('gradeSlider', config.grade)
            setSliderValue('sizeSlider', config.size)
            setSliderValue('offsetSlider', config.offset)
            setSliderValue('opacitySlider', config.opacity)

            // Set effects
            document.querySelectorAll('.effect-option').forEach(option => {
                option.classList.toggle(
                    'active',
                    config.effects.includes(option.dataset.effect)
                )
            })

            // Select icon
            selectedIcon = config.icon
            updatePreview()

            showNotification('Configuration loaded successfully!')
        } catch (error) {
            handleError(error)
        }
    }

    function deleteConfiguration(configId) {
        try {
            const savedConfigs = getSavedConfigurations()
            delete savedConfigs[configId]
            localStorage.setItem('iconStudioConfigs', JSON.stringify(savedConfigs))
            updateSavedConfigsList()
            showNotification('Configuration deleted')
        } catch (error) {
            handleError(error)
        }
    }

    function updateSavedConfigsList() {
        const container = document.querySelector('.saved-icons')
        if (!container) {
            console.warn('Saved icons container not found')
            return
        }

        const configs = getSavedConfigurations()

        // Clear and initialize container
        try {
            container.innerHTML = '<h3>Saved Configurations</h3>'

            if (Object.keys(configs).length === 0) {
                container.innerHTML +=
                    '<p class="no-saves">No saved configurations</p>'
                return
            }

            const list = document.createElement('div')
            list.className = 'saved-configs-list'

            Object.entries(configs)
                .sort(([, a], [, b]) => b.timestamp - a.timestamp)
                .forEach(([id, config]) => {
                    const item = document.createElement('div')
                    item.className = 'saved-config-item'
                    item.innerHTML = `
                    <span class="config-icon">
                        ${config.library === 'material'
                            ? `<span class="material-symbols-${config.family}">${config.icon}</span>`
                            : `<i class="fa-${config.family} fa-${config.icon}"></i>`
                        }
                    </span>
                    <span class="config-name">${config.name}</span>
                    <div class="config-actions">
                        <button class="button" onclick="loadConfiguration('${id}')">Load</button>
                        <button class="button delete" onclick="deleteConfiguration('${id}')">Delete</button>
                    </div>
                `
                    list.appendChild(item)
                })

            container.appendChild(list)
        } catch (error) {
            console.error('Error updating saved configs list:', error)
        }
    }

    // Add this to your initialization
    function initializeSavedConfigs() {
        updateSavedConfigsList()
    }

    // Export Functions
    function showExportModal() {
        const modal = document.getElementById('exportModal')
        const themeCode = generateThemeCSS()
        document.getElementById('themeCode').textContent = themeCode
        modal.classList.add('active')
    }

    function generateThemeCSS() {
        const config = getCurrentConfiguration()

        let css = `/* Icon Studio Theme Export */
/* Generated: ${new Date().toLocaleString()} */\n\n`

        if (currentLibrary === 'material') {
            css += generateMaterialThemeCSS(config)
        } else {
            css += generateFontAwesomeThemeCSS(config)
        }

        // Add effect classes
        css += generateEffectClassesCSS()

        return css
    }

    function generateMaterialThemeCSS(config) {
        return `/* Material Symbols Base Styles */
.material-symbols-${config.family} {
    font-variation-settings: 
        'FILL' ${config.fill},
        'wght' ${config.weight},
        'GRAD' ${config.grade},
        'opsz' ${config.size};
}

/* Two-tone Effect Base */
.material-symbols-${config.family}.two-tone {
    position: relative;
    display: inline-block;
    color: ${config.primaryColor};
}

.material-symbols-${config.family}.two-tone::after {
    content: attr(data-icon);
    position: absolute;
    left: ${config.offset}px;
    top: ${config.offset}px;
    color: ${config.secondaryColor};
    z-index: -1;
}\n`
    }

    function generateFontAwesomeThemeCSS(config) {
        return `/* Font Awesome Base Styles */
.fa-${config.family}.two-tone-wrapper {
    position: relative;
    display: inline-block;
}

.fa-${config.family}.two-tone {
    color: ${config.primaryColor};
}

.fa-${config.family}.two-tone-secondary {
    position: absolute;
    left: ${config.offset}px;
    top: ${config.offset}px;
    color: ${config.secondaryColor};
    opacity: ${config.opacity};
    z-index: -1;
}\n`
    }

    function generateEffectClassesCSS() {
        return `
/* Effect Classes */
.icon-shadow {
    filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
}

.icon-glow {
    filter: drop-shadow(0 0 5px var(--icon-color, currentColor));
}

.icon-gradient {
    background: linear-gradient(45deg, var(--icon-gradient-start, #000), var(--icon-gradient-end, #666));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}\n`
    }

    function copyCSS() {
        const cssCode = document.getElementById('cssCode').textContent
        copyToClipboard(cssCode)
    }

    function copyThemeCSS() {
        const themeCode = document.getElementById('themeCode').textContent
        copyToClipboard(themeCode)
    }

    function downloadThemeCSS() {
        const themeCode = document.getElementById('themeCode').textContent
        const config = getCurrentConfiguration()
        const filename = `icon-studio-theme-${config.library}-${config.family
            }-${selectedIcon}-${new Date().toISOString().split('T')[0]}.css`
        downloadFile(themeCode, filename, 'text/css')
    }

function exportAsPNG(size) {
    if (!selectedIcon) return;

// Get configuration from working icons if it exists
const identifier = workingIconsManager.generateIdentifier(getCurrentConfiguration());
    const config = workingIconsManager.icons.get(identifier) || getCurrentConfiguration();

    
    // Create canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Get all current settings
    const primaryColor = document.getElementById('primaryColor').value;
    const secondaryColor = document.getElementById('secondaryColor').value;
    const offset = parseFloat(document.getElementById('offsetSlider').value);
    const effects = Array.from(document.querySelectorAll('.effect-option.active'))
        .map(opt => opt.dataset.effect);
    
    // Determine padding based on effects
    const baseGlowPadding = 40;
    const padding = effects.includes('glow') ? baseGlowPadding : 20;
    
    // Set canvas size with padding for effects
    canvas.width = size + (padding * 2);
    canvas.height = size + (padding * 2);
    
    // Setup font with variations if Material
    if (currentLibrary === 'material') {
        const weight = document.getElementById('weightSlider').value;
        const fill = document.getElementById('fillSlider').value;
        const grade = document.getElementById('gradeSlider').value;
        ctx.font = `normal normal 400 ${size}px 'Material Symbols ${currentFamily}'`;
        const fontSettings = `'FILL' ${fill}, 'wght' ${weight}, 'GRAD' ${grade}, 'opsz' ${size}`;
        canvas.style.fontVariationSettings = fontSettings;
        ctx.canvas.style.fontVariationSettings = fontSettings;
    } else {
        ctx.font = `${size}px 'Font Awesome 6 ${currentFamily}'`;
    }
    
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Function to draw the icon with specific color/position
    function drawIcon(color, offsetX = 0, offsetY = 0) {
        ctx.fillStyle = color;
        
        if (effects.includes('shadow')) {
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
        }
        
        if (effects.includes('glow')) {
            ctx.shadowColor = color;
            ctx.shadowBlur = 20; // Increased blur for more visible glow
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }
        
        const centerX = canvas.width/2 + offsetX;
        const centerY = canvas.height/2 + offsetY;
        
        ctx.fillText(selectedIcon, centerX, centerY);
        
        // Reset shadow effects
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
    }
    
    // Clear canvas with transparency
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    


if (effects.includes('gradient')) {
    const direction = GRADIENT_DIRECTIONS[currentGradientAngle];
    if (direction) {
        console.log('Gradient Export Debug:', {
            'Direction Name': currentGradientAngle,
            'CSS Angle': `${direction.angle}deg`,
            'Start Coordinates': `(${direction.coords.start[0]}, ${direction.coords.start[1]})`,
            'End Coordinates': `(${direction.coords.end[0]}, ${direction.coords.end[1]})`,
            'Canvas Size': `${canvas.width} x ${canvas.height}`,
            'Actual Start Point': `(${canvas.width * direction.coords.start[0]}, ${canvas.height * direction.coords.start[1]})`,
            'Actual End Point': `(${canvas.width * direction.coords.end[0]}, ${canvas.height * direction.coords.end[1]})`,
            'Primary Color': primaryColor,
            'Secondary Color': secondaryColor
        });

        const gradient = ctx.createLinearGradient(
            canvas.width * direction.coords.start[0],
            canvas.height * direction.coords.start[1],
            canvas.width * direction.coords.end[0],
            canvas.height * direction.coords.end[1]
        );
        gradient.addColorStop(0, primaryColor);
        gradient.addColorStop(1, secondaryColor);
        ctx.fillStyle = gradient;
        drawIcon(gradient);

        // Log the current icon state
        console.log('Icon State:', {
            'Selected Icon': selectedIcon,
            'Library': currentLibrary,
            'Family': currentFamily
        });
    } else {
        console.warn('No direction found for angle:', currentGradientAngle);
    }
}

    // Create final canvas with proper cropping
    const finalCanvas = document.createElement('canvas');
    const finalSize = size + (effects.includes('glow') ? baseGlowPadding : 0);
    finalCanvas.width = finalSize;
    finalCanvas.height = finalSize;
    const finalCtx = finalCanvas.getContext('2d');
    
    // Draw the padded canvas onto the final canvas, preserving glow
    finalCtx.drawImage(
        canvas,
        padding/2, padding/2, 
        canvas.width - padding, canvas.height - padding,
        0, 0, finalSize, finalSize
    );

    // Create download link
    const link = document.createElement('a');
    link.download = `icon-studio-${selectedIcon}-${size}x${size}.png`;
    link.href = finalCanvas.toDataURL('image/png');
    link.click();
}
    
    
    
    
    function initializeModals() {
        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) {
                    modal.classList.remove('active')
                }
            })
        })

        // Close button handling
        document.querySelectorAll('.modal-close').forEach(button => {
            button.addEventListener('click', () => {
                button.closest('.modal').classList.remove('active')
            })
        })

        // Export modal buttons
        document
            .getElementById('copyThemeBtn')
            .addEventListener('click', copyThemeCSS)
        document
            .getElementById('downloadThemeBtn')
            .addEventListener('click', downloadThemeCSS)
    }
</script>

</html>
